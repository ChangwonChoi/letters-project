<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Make your imaginary character</title>
    <style>
      :root {
        --bg: #87ceeb;
        --text: #0b1220;
        --btn-bg: white;
        --btn-text: #0b1220;
        --btn-border: rgba(0,0,0,.1);
        --btn-shadow: 0 8px 24px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.06);
        --radius: 14px;
        --ok: #22c55e;
        --bar-bg: rgba(255,255,255,.6);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; margin: 0; }
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background: var(--bg);
        display: grid;
        place-items: center;
        min-height: 100vh;
      }

      main { display: flex; flex-direction: column; align-items: center; gap: 16px; text-align: center; width: 100%; max-width: 960px; padding: 20px; }
      h1 { margin: 0; font-size: clamp(26px, 5vw, 44px); line-height: 1.15; }
      p.subtitle { margin: 0; font-size: 14px; color: rgba(11, 18, 32, 0.7); }

      .actions { display: flex; flex-direction: column; align-items: center; gap: 16px; margin-top: 8px; }
      .btn {
        appearance: none; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--btn-text);
        font-weight: 600; font-size: 16px; padding: 14px 0; border-radius: var(--radius); box-shadow: var(--btn-shadow);
        cursor: pointer; text-decoration: none; width: 200px; text-align: center; transition: transform .08s ease, box-shadow .2s ease;
      }
      .btn:hover { transform: translateY(-1px); }
      .btn:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,.12); }
      .hidden { display: none !important; }

      /* === Input bars screen === */
      #barsScreen { width: 100%; max-width: 760px; display: grid; gap: 18px; margin-top: 20px; }
      .bar {
        background: var(--bar-bg);
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 999px;
        height: 32px;
        overflow: hidden;
        position: relative;
        box-shadow: var(--btn-shadow);
      }
      .bar::after {
        content: '';
        position: absolute;
        top: 0; left: 0;
        width: 0%;
        height: 100%;
        background: var(--ok);
        transition: width 0.4s ease;
      }
      .bar.filled::after { width: 100%; }

      /* === Build stage === */
      #buildPage h2 { margin: 6px 0 16px; }
      .stage {
        position: relative;
        width: min(720px, 92vw);
        height: min(540px, 69vw);
        margin: 0 auto 12px;
        background: #e9eef7;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--btn-shadow);
      }
      .stage img { position: absolute; image-rendering: auto; max-width: none; max-height: none; }
      .bgImg { inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
      .bodyImg { width: 60%; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 1; object-fit: contain; }
      .accImg { width: 28%; left: 4%; bottom: 6%; z-index: 2; object-fit: contain; }
      .headImg {
        width: 25%;
        left: calc(50% - 60% * 0.5);
        top: calc(50% - 60% * 0.5 - 12%);
        z-index: 3;
        object-fit: contain;
      }

      #gifContainer {
        position: absolute; inset: 0; display: none; z-index: 5; pointer-events: none;
        opacity: 1; transition: opacity 400ms ease;
      }
      #gifContainer.hide { opacity: 0; }
      .center-gif {
        position: absolute;
        top: 0; bottom: 0; left: 50%;
        transform: translateX(-50%);
        height: 100%; width: auto; max-height: none; object-fit: contain;
      }

      .nameRow { display: flex; gap: 8px; justify-content: center; align-items: center; margin-top: 6px; flex-wrap: wrap; }
      .nameRow input[type="text"] {
        width: min(360px, 80vw); padding: 10px 12px; border: 1px solid var(--btn-border);
        border-radius: 10px; font-size: 16px; box-shadow: var(--btn-shadow);
      }
      .nameRow .btn { width: auto; padding: 12px 16px; }
    </style>
  </head>
  <body>
    <main id="main">
      <div id="landing">
        <h1>Make your imaginary character</h1>
        <p class="subtitle">☠️A totally unexpected identity!☠️</p>
        <div class="actions">
          <button class="btn" id="goBtn">GO</button>
        </div>
      </div>

      <!-- 4개의 막대만 보여주는 화면 -->
      <section id="barsScreen" class="hidden" aria-live="polite">
        <div class="bar" id="bar-num"></div>
        <div class="bar" id="bar-col"></div>
        <div class="bar" id="bar-act"></div>
        <div class="bar" id="bar-per"></div>
      </section>

      <!-- 캐릭터 출력 화면 -->
      <section id="buildPage" class="hidden" aria-live="polite">
        <h2>Your Character Build</h2>
        <div class="stage" id="stage">
          <div id="gifContainer"></div>
        </div>
        <div class="nameRow">
          <input id="charName" type="text" placeholder="Name your character (optional)" aria-label="Character name" />
          <button id="downloadBtn" class="btn" type="button">Download PNG</button>
        </div>
      </section>
    </main>

    <script>
      let ansNumber = null, ansColor = null, ansAction = null, ansPersonality = null;
      let gotNum = false, gotCol = false, gotAct = false, gotPer = false;

      const goBtn = document.getElementById('goBtn');
      const landing = document.getElementById('landing');
      const barsScreen = document.getElementById('barsScreen');
      const buildPage = document.getElementById('buildPage');
      const stage = document.getElementById('stage');
      const gifContainer = document.getElementById('gifContainer');

      const barNum = document.getElementById('bar-num');
      const barCol = document.getElementById('bar-col');
      const barAct = document.getElementById('bar-act');
      const barPer = document.getElementById('bar-per');

      const GIF_URL = 'https://i.imgur.com/jzampoB.gif';

      const numberMap = {
  '1': 'https://i.imgur.com/t6wmmXS.png',
  '2': 'https://i.imgur.com/aYcxOFK.png',
  '3': 'https://i.imgur.com/MQVkf5h.png',
  '4': 'https://i.imgur.com/HNluGp9.png',
  '5': 'https://i.imgur.com/OQuNvZ1.png',
  '6': 'https://i.imgur.com/aIrevEj.png',
  '7': 'https://i.imgur.com/AmigoXX.png',
  '8': 'https://i.imgur.com/E9ey86q.png',
  '9': 'https://i.imgur.com/KItlOJO.png',
  '0': 'https://i.imgur.com/4z1Q93I.png'
};

      const colorMap = {
  q: 'https://i.imgur.com/32laQFa.png',
  w: 'https://i.imgur.com/YMQFes4.png',
  e: 'https://i.imgur.com/eDy3iIo.png',
  r: 'https://i.imgur.com/79xkzmS.png',
  t: 'https://i.imgur.com/iGrGeM2.png',
  y: 'https://i.imgur.com/CXN4q9X.png',
  u: 'https://i.imgur.com/70lkf6h.png',
  i: 'https://i.imgur.com/c9k726C.png',
  o: 'https://i.imgur.com/FOiiOyA.png',
  p: 'https://i.imgur.com/Qm63jNB.png'
};

      const actionMap = {
  a: 'https://i.imgur.com/sQwSsz1.png',
  s: 'https://i.imgur.com/7Kthzct.png',
  d: 'https://i.imgur.com/mo5HsmK.png',
  f: 'https://i.imgur.com/vYfhbOC.png',
  g: 'https://i.imgur.com/0lNZPxh.png',
  h: 'https://i.imgur.com/Dyf6maI.png',
  j: 'https://i.imgur.com/x81iFE3.png',
  k: 'https://i.imgur.com/eE8rSyY.png',
  l: 'https://i.imgur.com/CX1i3Lm.png'
};

      const personalityMap = {
  z: 'https://i.imgur.com/QcmfTXU.jpeg',
  x: 'https://i.imgur.com/I2e5l79.jpeg',
  c: 'https://i.imgur.com/83HH7Ye.jpeg',
  v: 'https://i.imgur.com/obKd47E.jpeg',
  b: 'https://i.imgur.com/rP1ljxf.jpeg',
  n: 'https://i.imgur.com/MRUlYA8.png',
  m: 'https://i.imgur.com/bGeuYVl.jpeg'
};


      goBtn.addEventListener('click', () => {
        landing.classList.add('hidden');
        barsScreen.classList.remove('hidden');
        document.addEventListener('keydown', handleAnyKey);
      });

      function fillBar(barEl) {
        barEl.classList.add('filled');
      }

      function handleAnyKey(e) {
        const lower = e.key.toLowerCase();
        if (!lower) return;

        if (!gotNum && lower >= '0' && lower <= '9') {
          ansNumber = lower; gotNum = true; fillBar(barNum); maybeBuild(); return;
        }
        if (!gotCol && 'qwertyuiop'.includes(lower)) {
          ansColor = lower; gotCol = true; fillBar(barCol); maybeBuild(); return;
        }
        if (!gotAct && 'asdfghjkl'.includes(lower)) {
          ansAction = lower; gotAct = true; fillBar(barAct); maybeBuild(); return;
        }
        if (!gotPer && 'zxcvbnm'.includes(lower)) {
          ansPersonality = lower; gotPer = true; fillBar(barPer); maybeBuild(); return;
        }
      }

      function allFilled() { return gotNum && gotCol && gotAct && gotPer; }

      function maybeBuild() {
        if (!allFilled()) return;
        document.removeEventListener('keydown', handleAnyKey);
        barsScreen.classList.add('hidden');
        buildPage.classList.remove('hidden');

        stage.innerHTML = '<div id=\"gifContainer\"></div>';
        const gif = document.getElementById('gifContainer');

        const headUrl = numberMap[ansNumber] || null;
        const bodyUrl = colorMap[ansColor] || null;
        const accUrl  = actionMap[ansAction] || null;
        const bgUrl   = personalityMap[ansPersonality] || null;

        if (bgUrl) stage.appendChild(makeImg(bgUrl, 'bgImg'));
        if (bodyUrl) stage.appendChild(makeImg(bodyUrl, 'bodyImg'));
        if (accUrl) stage.appendChild(makeImg(accUrl, 'accImg'));
        if (headUrl) stage.appendChild(makeImg(headUrl, 'headImg'));

        if (GIF_URL) showCenterGif(GIF_URL, gif);
      }

      function makeImg(src, cls) {
        const img = document.createElement('img');
        img.src = src; img.alt = ''; img.className = cls; img.loading = 'eager';
        return img;
      }

      function showCenterGif(url, container) {
        container.style.display = 'block';
        container.innerHTML = '';
        const img = document.createElement('img');
        img.src = url; img.alt = 'Intro GIF'; img.className = 'center-gif';
        container.appendChild(img);
        setTimeout(() => {
          container.classList.add('hide');
          setTimeout(() => { container.style.display = 'none'; container.innerHTML = ''; }, 420);
        }, 3000);
      }

      document.getElementById('downloadBtn').addEventListener('click', async () => {
        const W = stage.clientWidth || 720, H = stage.clientHeight || 540;
        const canvas = document.createElement('canvas'); canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');
        const load = (url) => new Promise((res, rej) => {
          if (!url) return res(null);
          const img = new Image(); img.crossOrigin = 'anonymous';
          img.onload = () => res(img); img.onerror = rej; img.src = url;
        });

        const headUrl = numberMap[ansNumber] || null;
        const bodyUrl = colorMap[ansColor] || null;
        const accUrl  = actionMap[ansAction] || null;
        const bgUrl   = personalityMap[ansPersonality] || null;
        try {
          const [bg, body, acc, head] = await Promise.all([load(bgUrl), load(bodyUrl), load(accUrl), load(head)]);
          if (bg) {
            const rStage = W/H, rImg = bg.width/bg.height;
            let dw, dh, dx, dy;
            if (rImg>rStage){dh=H;dw=dh*rImg;dx=(W-dw)/2;dy=0;} else {dw=W;dh=dw/rImg;dx=0;dy=(H-dh)/2;}
            ctx.drawImage(bg,dx,dy,dw,dh);
          } else { ctx.fillStyle='#e9eef7';ctx.fillRect(0,0,W,H); }
          if (body){const bodyW=W*0.6,bodyH=bodyW*(body.height/body.width),bodyX=(W-bodyW)/2,bodyY=(H-bodyH)/2;ctx.drawImage(body,bodyX,bodyY,bodyW,bodyH);}
          if (acc){const accW=W*0.28,accH=accW*(acc.height/acc.width),accX=W*0.04,accY=H-(H*0.06)-accH;ctx.drawImage(acc,accX,accY,accW,accH);}
          if (head){const headW=W*0.25,headH=headW*(head.height/head.width),headX=W*0.20,headY=H*0.08;ctx.drawImage(head,headX,headY,headW,headH);}
          const name=(document.getElementById('charName').value||'character').trim();
          const link=document.createElement('a');
          link.download=`${name||'character'}.png`;
          link.href=canvas.toDataURL('image/png');
          link.click();
        } catch(err){alert('Download failed'); console.error(err);}
      });
    </script>
  </body>
</html>
